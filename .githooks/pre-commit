#!/usr/bin/env bash
#
# pre-commit hook: checks git user identity before committing.
# - Blocks if user.name or user.email is not set.
# - Displays current identity so you can verify it's yours.
#

USER_NAME=$(git config user.name)
USER_EMAIL=$(git config user.email)

# Block if identity is missing
ERRORS=""
if [ -z "$USER_NAME" ]; then
  ERRORS="${ERRORS}  - user.name is not set\n"
fi
if [ -z "$USER_EMAIL" ]; then
  ERRORS="${ERRORS}  - user.email is not set\n"
fi

if [ -n "$ERRORS" ]; then
  echo ""
  echo "ERROR: Git identity is not configured."
  echo ""
  echo -e "$ERRORS"
  echo "  Set your identity with:"
  echo "    git config user.name \"Your Name\""
  echo "    git config user.email \"your@email.com\""
  echo ""
  exit 1
fi

# Display current identity for verification
echo ""
echo "Committing as: $USER_NAME <$USER_EMAIL>"
echo ""
echo "  If this is not you, abort (Ctrl+C) and run:"
echo "    git config user.name \"Your Name\""
echo "    git config user.email \"your@email.com\""
echo ""
echo "  If you already committed with the wrong identity, fix it with:"
echo "    git commit --amend --author=\"Your Name <your@email.com>\" --no-edit"
echo ""

# --- trace_analyzer regression tests ---
PROFILE_DIR="$(git rev-parse --show-toplevel)/profile"

if git diff --cached --name-only | grep -q "profile/trace_analyzer.py"; then
    echo "==> trace_analyzer.py modified â€” running regression tests (no cache)..."
    echo ""

    # Run unit tests first (fast, no trace files needed)
    python -m pytest "$PROFILE_DIR/tests/test_classifier_unit.py" \
                     "$PROFILE_DIR/tests/test_layer_detector_unit.py" \
                     -v --tb=short
    UNIT_EXIT=$?

    if [ $UNIT_EXIT -ne 0 ]; then
        echo ""
        echo "==> UNIT TESTS FAILED. Commit aborted."
        exit 1
    fi

    # Run regression tests with --regen-snapshots (re-parses traces, skips pickle cache)
    python -m pytest "$PROFILE_DIR/tests/test_regression.py" \
                     -v --tb=short --regen-snapshots
    REGR_EXIT=$?

    if [ $REGR_EXIT -ne 0 ]; then
        echo ""
        echo "==> REGRESSION TESTS FAILED. Commit aborted."
        echo "    If failures are expected (new model support), update baselines:"
        echo "    python tests/generate_baselines.py --all"
        exit 1
    fi

    echo ""
    echo "==> All tests passed."
fi

exit 0
