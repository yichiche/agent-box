<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGLang ROCm Perf Regression Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header>
        <h1>SGLang ROCm Performance Regression Dashboard</h1>
        <div class="health-badge" id="health-badge">Loading...</div>
    </header>

    <div class="filter-bar">
        <div class="filter-group">
            <label>Date Range:</label>
            <select id="filter-days">
                <option value="3">3 days</option>
                <option value="14">14 days</option>
                <option value="30" selected>30 days</option>
                <option value="60">60 days</option>
            </select>
        </div>
        <div class="filter-group">
            <label>ROCm Version:</label>
            <select id="filter-rocm">
                <option value="all">All</option>
                <option value="700" selected>ROCm 700</option>
                <option value="720">ROCm 720</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Model:</label>
            <select id="filter-model">
                <option value="all">All</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Concurrency:</label>
            <select id="filter-concurrency">
                <option value="all">All</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="4">4</option>
                <option value="8">8</option>
                <option value="16">16</option>
            </select>
        </div>
        <div class="filter-group">
            <label>TP Size:</label>
            <select id="filter-tp">
                <option value="all">All</option>
                <option value="2">TP2</option>
                <option value="4">TP4</option>
                <option value="8">TP8</option>
            </select>
        </div>
        <div class="filter-group">
            <label>MTP:</label>
            <select id="filter-mtp">
                <option value="all">All</option>
                <option value="1" selected>Yes</option>
                <option value="0">No</option>
            </select>
        </div>
        <div class="filter-group">
            <label>EP Size:</label>
            <select id="filter-ep">
                <option value="all" selected>All</option>
                <option value="none">None</option>
                <option value="2">2</option>
                <option value="4">4</option>
                <option value="8">8</option>
            </select>
        </div>
        <div class="filter-group">
            <label>DP Size:</label>
            <select id="filter-dp">
                <option value="all" selected>All</option>
                <option value="none">None</option>
                <option value="2">2</option>
                <option value="4">4</option>
                <option value="8">8</option>
            </select>
        </div>
        <button id="btn-refresh" onclick="refreshAll()">Refresh</button>
    </div>

    <div class="charts-grid">
        <div class="chart-container">
            <h3>Output Throughput (tok/s)</h3>
            <canvas id="chart-output_throughput"></canvas>
        </div>
        <div class="chart-container">
            <h3>Total Throughput (tok/s)</h3>
            <canvas id="chart-total_throughput"></canvas>
        </div>
        <div class="chart-container">
            <h3>Median TTFT (ms)</h3>
            <canvas id="chart-median_ttft_ms"></canvas>
        </div>
        <div class="chart-container">
            <h3>Median ITL (ms)</h3>
            <canvas id="chart-median_itl_ms"></canvas>
        </div>
        <div class="chart-container">
            <h3>Median E2E Latency (ms)</h3>
            <canvas id="chart-median_e2e_latency_ms"></canvas>
        </div>
        <div class="chart-container">
            <h3>GSM8K Accuracy (%)</h3>
            <canvas id="chart-accuracy_pct"></canvas>
        </div>
    </div>

    <div class="tables-section">
        <h2>Variant Comparison</h2>
        <div class="filter-group" style="margin-bottom: 12px;">
            <label>Build Date:</label>
            <select id="variant-build-date"></select>
            <button class="btn-expand" onclick="loadVariantComparison()">Compare</button>
        </div>
        <table id="variant-table">
            <thead>
                <tr>
                    <th>Variant</th>
                    <th>Conc.</th>
                    <th>Out Throughput</th>
                    <th>Total Throughput</th>
                    <th>Med E2E (ms)</th>
                    <th>Med TTFT (ms)</th>
                    <th>Med ITL (ms)</th>
                    <th>Accuracy</th>
                </tr>
            </thead>
            <tbody id="variant-body">
                <tr><td colspan="8" class="empty">Select a build date to compare variants</td></tr>
            </tbody>
        </table>

        <h2>Run History</h2>
        <table id="runs-table">
            <thead>
                <tr>
                    <th>Build Date</th>
                    <th>Image Tag</th>
                    <th>Model</th>
                    <th>TP</th>
                    <th>MTP</th>
                    <th>EP</th>
                    <th>DP</th>
                    <th>SGLang</th>
                    <th>ROCm</th>
                    <th>Status</th>
                    <th>Duration</th>
                    <th>Accuracy</th>
                    <th>Versions</th>
                    <th>Details</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody id="runs-body">
                <tr><td colspan="15" class="empty">Loading...</td></tr>
            </tbody>
        </table>

        <h2>Regression Alerts</h2>
        <table id="alerts-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Image Tag</th>
                    <th>ROCm</th>
                    <th>TP</th>
                    <th>MTP</th>
                    <th>EP</th>
                    <th>DP</th>
                    <th>Metric</th>
                    <th>Concurrency</th>
                    <th>Current</th>
                    <th>Baseline</th>
                    <th>Degradation</th>
                    <th>Compare</th>
                </tr>
            </thead>
            <tbody id="alerts-body">
                <tr><td colspan="15" class="empty">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        const chartInstances = {};
        const metricKeys = [
            'output_throughput', 'total_throughput',
            'median_ttft_ms', 'median_itl_ms',
            'median_e2e_latency_ms', 'accuracy_pct'
        ];

        function getFilters() {
            return {
                days: document.getElementById('filter-days').value,
                rocm_version: document.getElementById('filter-rocm').value,
                model_name: document.getElementById('filter-model').value,
                concurrency: document.getElementById('filter-concurrency').value,
                tp_size: document.getElementById('filter-tp').value,
                mtp_enabled: document.getElementById('filter-mtp').value,
                ep_size: document.getElementById('filter-ep').value,
                dp_size: document.getElementById('filter-dp').value,
            };
        }

        async function fetchChartData() {
            const f = getFilters();
            const params = new URLSearchParams({
                days: f.days,
                rocm_version: f.rocm_version,
                model_name: f.model_name,
                concurrency: f.concurrency,
                tp_size: f.tp_size,
                mtp_enabled: f.mtp_enabled,
                ep_size: f.ep_size,
                dp_size: f.dp_size,
            });
            const resp = await fetch(`/api/chart-data?${params}`);
            return await resp.json();
        }

        async function fetchAlerts() {
            const f = getFilters();
            const params = new URLSearchParams({
                days: f.days,
                rocm_version: f.rocm_version,
                model_name: f.model_name,
                tp_size: f.tp_size,
                mtp_enabled: f.mtp_enabled,
                ep_size: f.ep_size,
                dp_size: f.dp_size,
            });
            const resp = await fetch(`/api/alerts?${params}`);
            return await resp.json();
        }

        async function fetchRuns() {
            const f = getFilters();
            const params = new URLSearchParams({
                days: f.days,
                rocm_version: f.rocm_version,
                model_name: f.model_name,
                tp_size: f.tp_size,
                mtp_enabled: f.mtp_enabled,
                ep_size: f.ep_size,
                dp_size: f.dp_size,
            });
            const resp = await fetch(`/api/runs?${params}`);
            return await resp.json();
        }

        async function fetchHealth() {
            const resp = await fetch('/api/health');
            return await resp.json();
        }

        function createChart(canvasId, chartData) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }

            const datasets = (chartData.datasets || []).map(ds => {
                const baseStyle = ds.pointStyle || 'circle';
                const baseRadius = ds.pointRadius || 4;
                return {
                    ...ds,
                    pointRadius: ds.data.map((_, i) =>
                        ds.pointBackgroundColor && ds.pointBackgroundColor[i] === '#FF0000' ? 8 : baseRadius
                    ),
                    pointStyle: ds.data.map((_, i) =>
                        ds.pointBackgroundColor && ds.pointBackgroundColor[i] === '#FF0000' ? 'triangle' : baseStyle
                    ),
                };
            });

            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'yyyy-MM-dd',
                                displayFormats: {
                                    day: 'yyyy-MM-dd',
                                },
                            },
                            title: { display: true, text: 'Build Date' },
                        },
                        y: {
                            title: { display: true, text: chartData.label },
                            beginAtZero: false,
                        },
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(items) {
                                    const d = items[0].raw;
                                    return d.tag || d.x;
                                },
                                label: function(ctx) {
                                    const d = ctx.raw;
                                    let label = `${ctx.dataset.label}: ${d.y}`;
                                    if (d.sglang) label += ` (${d.sglang})`;
                                    return label;
                                },
                            },
                        },
                        legend: {
                            position: 'bottom',
                            labels: { usePointStyle: true },
                        },
                    },
                },
            });
        }

        function renderAlerts(alerts) {
            const tbody = document.getElementById('alerts-body');
            if (!alerts || alerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" class="empty">No regression alerts</td></tr>';
                return;
            }
            tbody.innerHTML = alerts.map(a => {
                const date = `${a.build_date.slice(0,4)}-${a.build_date.slice(4,6)}-${a.build_date.slice(6)}`;
                const degradation = a.regression_pct > 0 ? `+${a.regression_pct.toFixed(1)}%` : `${a.regression_pct.toFixed(1)}%`;
                return `<tr class="alert-row">
                    <td>${date}</td>
                    <td class="tag-cell" title="${a.image_tag}">${a.image_tag}</td>
                    <td>${a.rocm_version}</td>
                    <td>${a.tp_size != null ? a.tp_size : '-'}</td>
                    <td>${a.mtp_enabled ? 'Yes' : 'No'}</td>
                    <td>${a.ep_size != null ? a.ep_size : '-'}</td>
                    <td>${a.dp_size != null ? a.dp_size : '-'}</td>
                    <td>${a.metric_name}</td>
                    <td>${a.concurrency !== null ? a.concurrency : 'N/A'}</td>
                    <td>${a.current_value !== null ? a.current_value.toFixed(2) : 'N/A'}</td>
                    <td>${a.baseline_value !== null ? a.baseline_value.toFixed(2) : 'N/A'}</td>
                    <td class="regression-val">${degradation}</td>
                    <td><button class="btn-expand" onclick="compareVersions(${a.run_id}, '${a.rocm_version}', this)">Compare</button></td>
                </tr>`;
            }).join('');
        }

        function renderRuns(runs) {
            const tbody = document.getElementById('runs-body');
            if (!runs || runs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" class="empty">No benchmark runs</td></tr>';
                return;
            }
            tbody.innerHTML = runs.map(r => {
                const date = `${r.build_date.slice(0,4)}-${r.build_date.slice(4,6)}-${r.build_date.slice(6)}`;
                const statusClass = r.status === 'completed' ? 'status-ok' :
                                    r.status === 'failed' ? 'status-fail' : 'status-pending';
                const duration = r.duration_total_sec ? `${(r.duration_total_sec / 60).toFixed(1)} min` : '-';
                const accuracy = r.accuracy ? `${r.accuracy.accuracy_pct.toFixed(1)}%` : '-';
                const metricsId = `metrics-${r.id}`;

                let metricsHtml = '';
                if (r.metrics && r.metrics.length > 0) {
                    metricsHtml = `<tr id="${metricsId}" class="metrics-detail" style="display:none">
                        <td colspan="15">
                            <table class="inner-table">
                                <thead>
                                    <tr>
                                        <th>Conc.</th>
                                        <th>Out Tput</th>
                                        <th>Total Tput</th>
                                        <th>Med E2E</th>
                                        <th>Med TTFT</th>
                                        <th>Med ITL</th>
                                        <th>P99 E2E</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${r.metrics.map(m => `<tr>
                                        <td>${m.concurrency}</td>
                                        <td>${m.output_throughput ? m.output_throughput.toFixed(1) : '-'}</td>
                                        <td>${m.total_throughput ? m.total_throughput.toFixed(1) : '-'}</td>
                                        <td>${m.median_e2e_latency_ms ? m.median_e2e_latency_ms.toFixed(1) : '-'}</td>
                                        <td>${m.median_ttft_ms ? m.median_ttft_ms.toFixed(1) : '-'}</td>
                                        <td>${m.median_itl_ms ? m.median_itl_ms.toFixed(1) : '-'}</td>
                                        <td>${m.p99_e2e_latency_ms ? m.p99_e2e_latency_ms.toFixed(1) : '-'}</td>
                                    </tr>`).join('')}
                                </tbody>
                            </table>
                        </td>
                    </tr>`;
                }

                let versionsHtml = '';
                if (r.versions && r.versions.length > 0) {
                    const versionsId = `versions-${r.id}`;
                    versionsHtml = `<tr id="${versionsId}" class="metrics-detail" style="display:none">
                        <td colspan="15">
                            <table class="inner-table">
                                <thead>
                                    <tr>
                                        <th>Library</th>
                                        <th>Version</th>
                                        <th>Source</th>
                                        <th>Commit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${r.versions.map(v => `<tr>
                                        <td>${v.library_name}</td>
                                        <td>${v.version || '-'}</td>
                                        <td>${v.source_type}</td>
                                        <td>${v.git_commit ? v.git_commit.substring(0, 10) : '-'}</td>
                                    </tr>`).join('')}
                                </tbody>
                            </table>
                        </td>
                    </tr>`;
                }

                const errorId = `error-${r.id}`;
                let errorHtml = '';
                if (r.status === 'failed') {
                    const errorText = r.error_message
                        ? r.error_message.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                        : '';
                    errorHtml = `<tr id="${errorId}" class="metrics-detail" style="display:none">
                        <td colspan="15">
                            ${errorText ? `<pre class="error-message">${errorText}</pre>` : ''}
                            <pre class="error-message server-log" id="serverlog-${r.id}">Loading server.log...</pre>
                        </td>
                    </tr>`;
                }

                const statusTd = r.status === 'failed'
                    ? `<span class="${statusClass} status-clickable" onclick="toggleError('${errorId}', ${r.id}, this)">${r.status}</span>`
                    : `<span class="${statusClass}">${r.status}</span>`;

                return `<tr>
                    <td>${date}</td>
                    <td class="tag-cell" title="${r.image_tag}">${r.image_tag}</td>
                    <td>${r.model_name || '-'}</td>
                    <td>${r.tp_size != null ? r.tp_size : '-'}</td>
                    <td>${r.mtp_enabled ? 'Yes' : 'No'}</td>
                    <td>${r.ep_size != null ? r.ep_size : '-'}</td>
                    <td>${r.dp_size != null ? r.dp_size : '-'}</td>
                    <td>${r.sglang_version || '-'}</td>
                    <td>${r.rocm_version || '-'}</td>
                    <td>${statusTd}</td>
                    <td>${duration}</td>
                    <td>${accuracy}</td>
                    <td>${r.versions && r.versions.length > 0 ?
                        `<button class="btn-expand" onclick="toggleMetrics('versions-${r.id}', this)">Show</button>` : '-'}</td>
                    <td>${r.metrics && r.metrics.length > 0 ?
                        `<button class="btn-expand" onclick="toggleMetrics('${metricsId}', this)">Show</button>` : '-'}</td>
                    <td><button class="btn-expand" onclick="deleteRun(${r.id}, '${r.image_tag}', this)">Delete</button></td>
                </tr>${metricsHtml}${versionsHtml}${errorHtml}`;
            }).join('');
        }

        async function deleteRun(runId, imageTag, btn) {
            if (!confirm(`Delete run ${imageTag}?`)) return;
            btn.textContent = '...';
            try {
                const resp = await fetch(`/api/runs/${runId}`, { method: 'DELETE' });
                if (!resp.ok) throw new Error('Delete failed');
                refreshAll();
            } catch (err) {
                alert('Failed to delete run: ' + err.message);
                btn.textContent = 'Delete';
            }
        }

        function toggleMetrics(id, btn) {
            const row = document.getElementById(id);
            if (row) {
                const isHidden = row.style.display === 'none';
                row.style.display = isHidden ? 'table-row' : 'none';
                btn.textContent = isHidden ? 'Hide' : 'Show';
            }
        }

        async function toggleError(rowId, runId, btn) {
            const row = document.getElementById(rowId);
            if (!row) return;
            const isHidden = row.style.display === 'none';
            row.style.display = isHidden ? 'table-row' : 'none';
            if (!isHidden) return;

            const logEl = document.getElementById(`serverlog-${runId}`);
            if (logEl.dataset.loaded) return;

            try {
                const resp = await fetch(`/api/runs/${runId}/server-log?tail=200`);
                const data = await resp.json();
                if (data.log) {
                    logEl.textContent = data.log;
                } else {
                    logEl.textContent = data.reason || 'server.log not available';
                }
            } catch (err) {
                logEl.textContent = 'Failed to load server.log: ' + err.message;
            }
            logEl.dataset.loaded = '1';
        }

        async function compareVersions(runId, rocmVersion, btn) {
            // Find the previous completed run with the same rocm_version
            const f = getFilters();
            const params = new URLSearchParams({ days: f.days, rocm_version: rocmVersion, model_name: f.model_name });
            const runs = await (await fetch(`/api/runs?${params}`)).json();
            const completedRuns = runs.filter(r => r.status === 'completed').sort((a, b) => a.build_date.localeCompare(b.build_date));
            const currentIdx = completedRuns.findIndex(r => r.id === runId);
            if (currentIdx <= 0) {
                alert('No previous run found for comparison');
                return;
            }
            const prevRun = completedRuns[currentIdx - 1];

            btn.textContent = 'Loading...';
            try {
                const diffResp = await fetch(`/api/version-diff?run_a=${prevRun.id}&run_b=${runId}`);
                const diffData = await diffResp.json();

                // Show in a simple alert/modal
                let msg = 'Version Diff:\n\n';
                if (diffData.diff.changed && diffData.diff.changed.length > 0) {
                    msg += 'CHANGED:\n';
                    diffData.diff.changed.forEach(c => {
                        const oldCommit = c.old_commit ? ` (${c.old_commit.substring(0, 7)})` : '';
                        const newCommit = c.new_commit ? ` (${c.new_commit.substring(0, 7)})` : '';
                        msg += `  ${c.name}: ${c.old_version}${oldCommit} -> ${c.new_version}${newCommit}\n`;
                    });
                } else {
                    msg += 'No version changes detected\n';
                }
                if (diffData.suggestions && diffData.suggestions.length > 0) {
                    msg += '\nRoot Cause Analysis:\n';
                    diffData.suggestions.forEach((s, i) => {
                        msg += `  ${i+1}. ${s.name} â€” ${s.reason}\n`;
                    });
                }
                alert(msg);
            } catch (err) {
                alert('Failed to compare versions: ' + err.message);
            }
            btn.textContent = 'Compare';
        }

        async function refreshAll() {
            document.getElementById('btn-refresh').textContent = 'Loading...';
            try {
                const [chartData, alerts, runs, health] = await Promise.all([
                    fetchChartData(), fetchAlerts(), fetchRuns(), fetchHealth(),
                ]);

                // Render charts
                for (const key of metricKeys) {
                    if (chartData[key]) {
                        createChart(`chart-${key}`, chartData[key]);
                    }
                }

                // Render tables
                renderAlerts(alerts);
                renderRuns(runs);

                // Health badge
                const badge = document.getElementById('health-badge');
                badge.textContent = `${health.completed_runs} runs | ${health.unacknowledged_alerts} alerts | ${health.disk_free_gb} GB free`;
                badge.className = health.unacknowledged_alerts > 0 ? 'health-badge warn' : 'health-badge ok';

            } catch (err) {
                console.error('Refresh failed:', err);
                document.getElementById('health-badge').textContent = 'Error loading data';
                document.getElementById('health-badge').className = 'health-badge error';
            }
            document.getElementById('btn-refresh').textContent = 'Refresh';
        }

        // Populate model filter dropdown from DB
        async function loadModels() {
            try {
                const resp = await fetch('/api/models');
                const models = await resp.json();
                const select = document.getElementById('filter-model');
                models.forEach((m, i) => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    select.appendChild(opt);
                });
                if (models.length > 0) {
                    select.value = models[0];
                }
            } catch (err) {
                console.error('Failed to load models:', err);
            }
        }

        async function loadBuildDates() {
            try {
                const runs = await fetchRuns();
                const dates = [...new Set(runs.map(r => r.build_date))].sort().reverse();
                const select = document.getElementById('variant-build-date');
                select.innerHTML = '';
                dates.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = `${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6)}`;
                    select.appendChild(opt);
                });
            } catch (err) {
                console.error('Failed to load build dates:', err);
            }
        }

        async function loadVariantComparison() {
            const buildDate = document.getElementById('variant-build-date').value;
            if (!buildDate) return;
            const rocm = document.getElementById('filter-rocm').value;
            const params = new URLSearchParams({ build_date: buildDate });
            if (rocm !== 'all') params.set('rocm_version', rocm);

            const resp = await fetch(`/api/variant-comparison?${params}`);
            const data = await resp.json();

            const tbody = document.getElementById('variant-body');
            if (!data.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty">No data for this build date</td></tr>';
                return;
            }

            let html = '';
            for (const variant of data) {
                let label = `TP${variant.tp_size}${variant.mtp_enabled ? '+MTP' : ''}`;
                if (variant.ep_size != null) label += `+EP${variant.ep_size}`;
                if (variant.dp_size != null) label += `+DP${variant.dp_size}`;
                if (variant.metrics.length === 0) {
                    html += `<tr><td>${label}</td><td colspan="6">-</td><td>${variant.accuracy_pct ? variant.accuracy_pct.toFixed(1) + '%' : '-'}</td></tr>`;
                    continue;
                }
                for (const m of variant.metrics) {
                    html += `<tr>
                        <td>${label}</td>
                        <td>${m.concurrency}</td>
                        <td>${m.output_throughput ? m.output_throughput.toFixed(1) : '-'}</td>
                        <td>${m.total_throughput ? m.total_throughput.toFixed(1) : '-'}</td>
                        <td>${m.median_e2e_latency_ms ? m.median_e2e_latency_ms.toFixed(1) : '-'}</td>
                        <td>${m.median_ttft_ms ? m.median_ttft_ms.toFixed(1) : '-'}</td>
                        <td>${m.median_itl_ms ? m.median_itl_ms.toFixed(1) : '-'}</td>
                        <td>${variant.accuracy_pct ? variant.accuracy_pct.toFixed(1) + '%' : '-'}</td>
                    </tr>`;
                }
            }
            tbody.innerHTML = html;
        }

        // Auto-refresh on filter change
        document.getElementById('filter-days').addEventListener('change', refreshAll);
        document.getElementById('filter-rocm').addEventListener('change', refreshAll);
        document.getElementById('filter-model').addEventListener('change', refreshAll);
        document.getElementById('filter-concurrency').addEventListener('change', refreshAll);
        document.getElementById('filter-tp').addEventListener('change', refreshAll);
        document.getElementById('filter-mtp').addEventListener('change', refreshAll);
        document.getElementById('filter-ep').addEventListener('change', refreshAll);
        document.getElementById('filter-dp').addEventListener('change', refreshAll);

        // Initial load
        loadModels();
        loadBuildDates();
        refreshAll();
        // Auto-refresh every 5 minutes
        setInterval(refreshAll, 300000);
    </script>
</body>
</html>
